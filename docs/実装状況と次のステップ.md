# OshiQuest 実装状況と次のステップ

## Phase 1 MVP 実装状況

### ✅ 完了項目

1. **データベース層**
   - ✅ 全テーブル定義（Players, GachaItems, Habits, Titles, PartyDecks, PartyMembers, UserSettings）
   - ✅ Enum定義（TaskType, Rarity, TaskDifficulty）
   - ✅ デフォルトPlayer作成（マイグレーション）

2. **画像インポート機能**
   - ✅ `GachaItemRepository.pickAndSaveItem()` 実装
   - ✅ 画像をアプリ内 `oshi_images` フォルダに保存
   - ✅ データベースへの登録

3. **基本的なUI**
   - ✅ Phase1HomeScreen（画像一覧表示）
   - ✅ ジェム数表示（AppBar）
   - ✅ 画像追加ボタン（FAB）

### ⚠️ 部分実装

1. **プレイヤーステータス管理**
   - ✅ データベース定義済み
   - ❌ UIでの表示・更新機能が未実装

2. **ガチャ機能**
   - ✅ データベース定義済み（GachaItems）
   - ❌ ガチャを引く機能が未実装
   - ❌ アンロック演出（既存のmagic_circle_dialogはあるが未統合）

### ❌ 未実装項目

1. **タスク（Habits）管理**
   - ✅ データベース定義済み
   - ❌ タスク作成・編集・削除機能
   - ❌ タスク完了機能
   - ❌ タスク完了によるステータス上昇ロジック

2. **装備機能**
   - ✅ データベース定義済み（PartyDecks, PartyMembers）
   - ❌ 1枠の装備機能（Main Slot）
   - ❌ 装備によるステータス補正の適用

## 次のステップ（優先順位順）

### ステップ1: タスク（Habits）管理機能の実装 ⭐ 最優先

**目的**: Phase 1 MVPのコアループ「タスク実行→ステータス上昇」を実現

**実装内容**:
1. **HabitRepository の作成**
   - `createHabit()`: タスク作成
   - `updateHabit()`: タスク更新
   - `completeHabit()`: タスク完了（ステータス上昇ロジック含む）
   - `watchAllHabits()`: タスク一覧の監視
   - `deleteHabit()`: タスク削除

2. **タスク作成・編集画面**
   - タスク名入力
   - タスクタイプ選択（STR/INT/LUCK/CHA）
   - 難易度選択（low/normal/high）
   - 報酬設定（ジェム、経験値）

3. **タスク一覧画面**
   - タスクの一覧表示
   - タスク完了ボタン
   - タスク編集・削除機能

4. **タスク完了ロジック**
   - タスクタイプに応じたステータス上昇
   - 難易度による報酬倍率計算
   - ジェム・経験値の付与
   - プレイヤーレベルアップ判定

**ファイル構成**:
```
lib/
  data/
    repositories/
      habit_repository.dart  # 新規作成
  logic/
    habit_controller.dart    # 新規作成（Riverpod）
  ui/
    screens/
      habit_list_screen.dart  # 新規作成
      habit_edit_screen.dart  # 新規作成
```

### ステップ2: ガチャ機能の実装

**目的**: 推し画像を「獲得」する体験を実現

**実装内容**:
1. **ガチャ抽選ロジック**
   - 未アンロックのGachaItemから抽選
   - レアリティに応じた確率（将来実装）
   - ジェム消費（100ジェム）

2. **ガチャ実行機能**
   - `GachaItemRepository.pullGacha()`: ガチャを引く
   - 既存の`magic_circle_dialog.dart`を統合
   - アンロック処理

3. **UI統合**
   - Phase1HomeScreenに「ガチャを引く」ボタン追加
   - ジェム不足時のエラーハンドリング

**ファイル構成**:
```
lib/
  data/
    repositories/
      gacha_item_repository.dart  # pullGacha()メソッド追加
  ui/
    screens/
      phase1_home_screen.dart     # ガチャボタン追加
```

### ステップ3: プレイヤーステータス表示・更新

**目的**: プレイヤーの成長を可視化

**実装内容**:
1. **プレイヤーステータス画面**
   - STR/INT/LUCK/CHA の表示
   - レベル・経験値の表示
   - ステータス上昇のアニメーション

2. **ステータス更新ロジック**
   - タスク完了時の自動更新
   - レベルアップ時の通知

**ファイル構成**:
```
lib/
  logic/
    player_controller.dart        # 新規作成
  ui/
    screens/
      player_status_screen.dart    # 新規作成
```

### ステップ4: 簡易装備機能（1枠）

**目的**: 推しを「装備」してステータス補正を受ける

**実装内容**:
1. **装備機能**
   - Main Slot（1枠）への装備
   - 装備中の推しのステータス補正をプレイヤーに適用
   - 装備解除機能

2. **UI**
   - 推し詳細画面に「装備する」ボタン
   - ホーム画面に装備中の推し表示

**ファイル構成**:
```
lib/
  data/
    repositories/
      party_repository.dart       # 新規作成（Phase 2用だが簡易版）
  ui/
    screens/
      gacha_item_detail_screen.dart # 新規作成
```

## 実装の優先順位

1. **最優先**: タスク管理機能（コアループの実現）
2. **高**: ガチャ機能（ゲーム性の核心）
3. **中**: プレイヤーステータス表示（成長の可視化）
4. **中**: 簡易装備機能（Phase 1 MVPの要件）

## 技術的な注意点

- **エラーハンドリング**: すべてのRepositoryメソッドで適切なエラーハンドリングを実装
- **状態管理**: Riverpod Generator（@riverpod）を使用
- **UI/UX**: Material 3デザイン、アニメーション（flutter_animate）を活用
- **プライバシー**: 画像は常にローカル保存、クラウドアップロード禁止

## Phase 1 MVP 完了の定義

以下の機能が動作すれば Phase 1 MVP は完了：

1. ✅ 画像をインポートしてBOXに追加できる
2. ⏳ タスクを作成・完了できる
3. ⏳ タスク完了でプレイヤーステータスが上昇する
4. ⏳ ガチャを引いて推しを獲得できる
5. ⏳ 推しを1枠装備してステータス補正を受けられる

