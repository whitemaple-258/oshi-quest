# OshiQuest データベース設計書

## 概要

OshiQuest は**Local-First**アーキテクチャを採用し、すべてのデータをローカル SQLite（Drift）に保存します。ユーザーの画像はプライバシー保護のため、デバイス内にのみ保存されます。

## データベーススキーマ

### 1. Players（プレイヤーテーブル）

ユーザー自身の成長を管理する RPG ステータス。

| カラム名        | 型       | 説明                                   | デフォルト値 |
| --------------- | -------- | -------------------------------------- | ------------ |
| id              | INTEGER  | 主キー（自動増分）                     | -            |
| level           | INTEGER  | プレイヤーレベル                       | 1            |
| experience      | INTEGER  | 累計経験値                             | 0            |
| str             | INTEGER  | 筋力ステータス                         | 0            |
| int             | INTEGER  | 知力ステータス                         | 0            |
| luck            | INTEGER  | 運ステータス                           | 0            |
| cha             | INTEGER  | 魅力ステータス                         | 0            |
| willGems        | INTEGER  | 所持ジェム数                           | 500          |
| currentDebuff   | TEXT     | 現在の状態異常（'curse_of_sloth'など） | NULL         |
| debuffExpiresAt | DATETIME | 状態異常の有効期限                     | NULL         |
| createdAt       | DATETIME | 作成日時                               | 現在時刻     |
| updatedAt       | DATETIME | 更新日時                               | 現在時刻     |

**ステータス説明:**

- **STR (筋力)**: 運動・体力系タスクで上昇。高難易度タスクの報酬倍率 UP
- **INT (知力)**: 勉強・仕事系タスクで上昇。獲得経験値 UP
- **LUCK (運)**: 掃除・寄付系タスクで上昇。ガチャ排出率・レアドロップ確率 UP
- **CHA (魅力)**: 美容・対人系タスクで上昇。推しとの親密度上昇速度 UP、パーティコスト上限 UP

### 2. GachaItems（ガチャアイテムテーブル）

推し画像とその装備としての能力を管理。

| カラム名   | 型       | 説明                                | デフォルト値 |
| ---------- | -------- | ----------------------------------- | ------------ |
| id         | INTEGER  | 主キー（自動増分）                  | -            |
| imagePath  | TEXT     | ローカル画像パス                    | -            |
| title      | TEXT     | 推しのタイトル                      | -            |
| rarity     | TEXT     | レアリティ（'N', 'R', 'SR', 'SSR'） | 'N'          |
| isUnlocked | BOOLEAN  | アンロック済みか                    | false        |
| strBonus   | INTEGER  | STR 補正値                          | 0            |
| intBonus   | INTEGER  | INT 補正値                          | 0            |
| luckBonus  | INTEGER  | LUCK 補正値                         | 0            |
| chaBonus   | INTEGER  | CHA 補正値                          | 0            |
| bondLevel  | INTEGER  | 親密度レベル                        | 0            |
| createdAt  | DATETIME | 作成日時                            | 現在時刻     |
| unlockedAt | DATETIME | アンロック日時                      | NULL         |

**レアリティ:**

- **N (Normal)**: 通常
- **R (Rare)**: レア
- **SR (Super Rare)**: スーパーレア
- **SSR (Super Super Rare)**: 最レア

### 3. Habits（習慣テーブル）

タスク/習慣の管理（Phase 1 MVP で必要）。

| カラム名    | 型       | 説明                                        | デフォルト値 |
| ----------- | -------- | ------------------------------------------- | ------------ |
| id          | INTEGER  | 主キー（自動増分）                          | -            |
| name        | TEXT     | タスク名                                    | -            |
| taskType    | TEXT     | タスクタイプ（'STR', 'INT', 'LUCK', 'CHA'） | -            |
| difficulty  | TEXT     | 難易度（'low', 'normal', 'high'）           | 'normal'     |
| rewardGems  | INTEGER  | 報酬ジェム数                                | 100          |
| rewardXp    | INTEGER  | 報酬経験値                                  | 10           |
| isCompleted | BOOLEAN  | 完了済みか                                  | false        |
| completedAt | DATETIME | 完了日時                                    | NULL         |
| dueDate     | DATETIME | 期限（サボり判定に使用）                    | NULL         |
| createdAt   | DATETIME | 作成日時                                    | 現在時刻     |
| updatedAt   | DATETIME | 更新日時                                    | 現在時刻     |

**難易度による報酬倍率:**

- **low**: 基本報酬 × 0.8
- **normal**: 基本報酬 × 1.0
- **high**: 基本報酬 × 1.5（STR が高いとさらに倍率 UP）

### 4. Titles（称号テーブル）

称号システム（Phase 2 で実装）。

| カラム名             | 型       | 説明                           | デフォルト値 |
| -------------------- | -------- | ------------------------------ | ------------ |
| id                   | INTEGER  | 主キー（自動増分）             | -            |
| name                 | TEXT     | 称号名（例：『早起きの達人』） | -            |
| description          | TEXT     | 説明                           | NULL         |
| passiveSkill         | TEXT     | パッシブスキル（JSON 形式）    | NULL         |
| unlockConditionType  | TEXT     | 獲得条件タイプ                 | -            |
| unlockConditionValue | TEXT     | 獲得条件の値                   | -            |
| isUnlocked           | BOOLEAN  | 獲得済みか                     | false        |
| unlockedAt           | DATETIME | 獲得日時                       | NULL         |
| createdAt            | DATETIME | 作成日時                       | 現在時刻     |

**獲得条件タイプ:**

- `login_days`: 累計ログイン日数
- `task_count`: 特定タスクの完了回数
- `qualification`: 資格取得（自己申告制）

**パッシブスキル例:**

- `morning_task_reward_bonus:5` → 午前中のタスク報酬 +5%

### 5. PartyDecks（パーティデッキテーブル）

パーティ編成のデッキ管理（Phase 2 で実装）。

| カラム名  | 型       | 説明                             | デフォルト値 |
| --------- | -------- | -------------------------------- | ------------ |
| id        | INTEGER  | 主キー（自動増分）               | -            |
| name      | TEXT     | デッキ名（例: '日常クエスト用'） | -            |
| isActive  | BOOLEAN  | アクティブなデッキか             | false        |
| createdAt | DATETIME | 作成日時                         | 現在時刻     |
| updatedAt | DATETIME | 更新日時                         | 現在時刻     |

**制限:**

- Free 版: 1 デッキまで
- Pro 版: 5 デッキまで

### 6. PartyMembers（パーティメンバーテーブル）

デッキに編成された推しの管理。

| カラム名     | 型       | 説明                            | デフォルト値 |
| ------------ | -------- | ------------------------------- | ------------ |
| id           | INTEGER  | 主キー（自動増分）              | -            |
| deckId       | INTEGER  | デッキ ID（外部キー）           | -            |
| gachaItemId  | INTEGER  | ガチャアイテム ID（外部キー）   | -            |
| slotPosition | INTEGER  | スロット位置（0=Main, 1-4=Sub） | -            |
| createdAt    | DATETIME | 作成日時                        | 現在時刻     |

**スロット構成:**

- **Main Slot (0)**: 1 枠。ホーム画面に表示、ボイス/励ましを担当
- **Sub Slots (1-4)**: 最大 4 枠。ステータス補正のみ適用

**制約:**

- 同じデッキ内で同じスロット位置に複数の推しは配置不可（ユニーク制約）

### 7. UserSettings（ユーザー設定テーブル）

Pro 版設定、UI テーマなど（Phase 3 で実装）。

| カラム名      | 型       | 説明                        | デフォルト値  |
| ------------- | -------- | --------------------------- | ------------- |
| id            | INTEGER  | 主キー（自動増分）          | -             |
| isPro         | BOOLEAN  | Pro 版か                    | false         |
| maxHabits     | INTEGER  | 最大習慣登録数              | 3（Free 版）  |
| maxGachaItems | INTEGER  | 最大推し画像 BOX 数         | 50（Free 版） |
| maxDecks      | INTEGER  | 最大デッキ数                | 1（Free 版）  |
| themeColor    | TEXT     | UI テーマカラー（Hex 形式） | NULL          |
| createdAt     | DATETIME | 作成日時                    | 現在時刻      |
| updatedAt     | DATETIME | 更新日時                    | 現在時刻      |

**制限値（Free 版 → Pro 版）:**

- maxHabits: 3 → 無制限
- maxGachaItems: 50 → 無制限
- maxDecks: 1 → 5

## リレーションシップ

```
Players (1) ──┐
              │
GachaItems (N) ──┐
                 │
              PartyMembers (N) ── PartyDecks (1)
                 │
              Habits (N)
                 │
              Titles (N)
                 │
              UserSettings (1) [シングルトン]
```

## インデックス

以下のカラムにインデックスを追加することを推奨：

- `GachaItems.isUnlocked` - アンロック済みアイテムの検索
- `Habits.taskType` - タスクタイプでの検索
- `Habits.isCompleted` - 完了済みタスクの検索
- `PartyMembers.deckId` - デッキ内のメンバー検索
- `PartyMembers.slotPosition` - スロット位置での検索

## マイグレーション戦略

現在のスキーマバージョン: **1**

将来のマイグレーション例：

- Phase 2: 称号システム、パーティ編成の追加
- Phase 3: Pro 版機能、UI テーマの追加
- 将来: ボイスデータ、アニメーション設定など

## プライバシーとセキュリティ

- **画像データ**: すべてローカルストレージに保存。クラウドへのアップロードは行わない
- **データベース**: デバイス内のアプリケーションドキュメントディレクトリに保存
- **バックアップ**: 将来的にローカルバックアップ機能を実装予定

## パフォーマンス考慮事項

- 画像パスは相対パスで保存し、ファイルサイズを最小化
- 頻繁にアクセスされるテーブル（Players, GachaItems）には適切なインデックスを設定
- バッチ処理で大量のデータを一度に更新する際は、トランザクションを使用
